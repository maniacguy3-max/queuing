<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Book Appointment</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; background:#f6f8fb; margin:0; }
    .wrap { max-width:640px; margin:40px auto; background:#fff; border-radius:12px; box-shadow:0 10px 25px rgba(0,0,0,.06); padding:24px 20px; }
    h1 { margin:0 0 12px; font-size:22px; }
    label { display:block; font-weight:600; margin-top:14px; }
    input, select, textarea, button {
      width:100%; padding:10px 12px; margin-top:6px; border:1px solid #d9e0ea; border-radius:8px; font-size:14px; box-sizing:border-box;
    }
    textarea { resize:vertical; min-height:90px; }
    button { background:#0b63f6; color:#fff; border:none; font-weight:700; cursor:pointer; margin-top:18px; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .row { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .msg { margin-top:14px; padding:10px 12px; border-radius:8px; display:none; }
    .ok { background:#e8f7ed; color:#116c2f; }
    .err { background:#fdecec; color:#b0122a; }
    .hint { font-size:12px; color:#667085; margin-top:6px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Book Appointment</h1>
    <form id="appointmentForm" autocomplete="off">
      <div class="row">
        <div>
          <label>First Name</label>
          <input id="firstName" required />
        </div>
        <div>
          <label>Last Name</label>
          <input id="lastName" required />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Age</label>
          <input id="age" type="number" min="0" required />
        </div>
        <div>
          <label>Sex</label>
          <select id="sex" required>
            <option value="">Select</option>
            <option>Male</option>
            <option>Female</option>
            <option>Prefer not to say</option>
          </select>
        </div>
      </div>

      <label>Phone</label>
      <input id="phone" type="tel" required />

      <label>Symptoms (category or brief)</label>
      <input id="symptoms" required />

      <label>Details (optional)</label>
      <textarea id="details" placeholder="Add anything helpful…"></textarea>

      <div class="row">
        <div>
          <label>Date</label>
          <input id="date" type="date" required />
          <div class="hint">Booked slots will be removed from the list below.</div>
        </div>
        <div>
          <label>Time Slot (hourly)</label>
          <select id="time" required>
            <option value="">Select time</option>
            <!-- options are generated by JS so we can disable/remove booked ones -->
          </select>
        </div>
      </div>

      <button id="submitBtn" type="submit">Submit</button>

      <div id="ok" class="msg ok"></div>
      <div id="err" class="msg err"></div>
    </form>
  </div>

  <!-- Firebase (v10 modular) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getDatabase, ref, onValue, runTransaction, push, set
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    // ✅ Your Firebase project (with regional databaseURL)
    const firebaseConfig = {
      apiKey: "AIzaSyAlQ2h3WdhMHVl9nwz_Ug3ejscxtWuEtlE",
      authDomain: "clinic-for-cho-queue.firebaseapp.com",
      databaseURL: "https://clinic-for-cho-queue-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "clinic-for-cho-queue",
      storageBucket: "clinic-for-cho-queue.firebasestorage.app",
      messagingSenderId: "420319378706",
      appId: "1:420319378706:web:6083b4ccd5338a7e9a07cb",
      measurementId: "G-S9XQE2SKFZ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const dateEl = document.getElementById("date");
    const timeEl = document.getElementById("time");
    const form = document.getElementById("appointmentForm");
    const ok = document.getElementById("ok");
    const err = document.getElementById("err");
    const submitBtn = document.getElementById("submitBtn");

    // Generate hourly slots (09:00–16:00)
    function buildTimeOptions(blockedSet = new Set()) {
      timeEl.innerHTML = '<option value="">Select time</option>';
      const hours = ["09:00","10:00","11:00","12:00","13:00","14:00","15:00","16:00"];
      hours.forEach(h => {
        if (!blockedSet.has(h)) {
          const opt = document.createElement("option");
          opt.value = h;
          opt.textContent = toHuman(h);
          timeEl.appendChild(opt);
        }
      });
      // If selected value became unavailable, reset selection
      if (!Array.from(timeEl.options).some(o => o.value === timeEl.value)) {
        timeEl.value = "";
      }
    }

    function toHuman(hhmm) {
      const [h,m] = hhmm.split(":").map(Number);
      const ampm = h >= 12 ? "PM" : "AM";
      const hh = ((h + 11) % 12) + 1;
      return `${String(hh).padStart(2,"0")}:${m.toString().padStart(2,"0")} ${ampm}`;
    }

    // Set min date = today
    const todayISO = new Date().toISOString().split("T")[0];
    dateEl.min = todayISO;

    // Load booked slots for selected date and prune dropdown
    let slotsUnsub = null;
    function watchSlotsForDate(dateStr) {
      if (slotsUnsub) slotsUnsub(); // detach previous listener
      if (!dateStr) { buildTimeOptions(); return; }

      const slotsRef = ref(db, `slots/${dateStr}`);
      const unsubscribe = onValue(slotsRef, (snap) => {
        const blocked = new Set();
        if (snap.exists()) {
          const val = snap.val();
          Object.keys(val).forEach(timeKey => {
            if (val[timeKey]) blocked.add(timeKey);
          });
        }
        buildTimeOptions(blocked);
      });
      slotsUnsub = unsubscribe;
    }

    dateEl.addEventListener("change", () => watchSlotsForDate(dateEl.value));
    // initial options
    buildTimeOptions();

    function showOK(text)  { ok.textContent = text; ok.style.display = "block"; err.style.display = "none"; }
    function showErr(text) { err.textContent = text; err.style.display = "block"; ok.style.display = "none"; }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      submitBtn.disabled = true;

      const firstName = document.getElementById("firstName").value.trim();
      const lastName  = document.getElementById("lastName").value.trim();
      const age       = document.getElementById("age").value.trim();
      const sex       = document.getElementById("sex").value.trim();
      const phone     = document.getElementById("phone").value.trim();
      const symptoms  = document.getElementById("symptoms").value.trim();
      const details   = document.getElementById("details").value.trim();
      const date      = dateEl.value;
      const time      = timeEl.value;

      if (!firstName || !lastName || !age || !sex || !phone || !symptoms || !date || !time) {
        showErr("Please fill out all required fields and choose a time.");
        submitBtn.disabled = false;
        return;
      }

      try {
        // 1) Atomically reserve the slot: slots/<date>/<time> must be empty -> true
        const slotRef = ref(db, `slots/${date}/${time}`);
        const slotResult = await runTransaction(slotRef, (current) => {
          if (current === null) { return true; } // reserve
          return; // returning undefined aborts
        });

        if (!slotResult.committed) {
          showErr("This time slot was just booked. Please choose another slot.");
          submitBtn.disabled = false;
          return;
        }

        // 2) Get per-date queue number atomically: counters/<date>++
        const counterRef = ref(db, `counters/${date}`);
        const counterResult = await runTransaction(counterRef, (current) => (current || 0) + 1);
        const queueNumber = counterResult.snapshot.val();

        // 3) Save full appointment
        const appt = {
          firstName, lastName, age, sex, phone, symptoms, details,
          date, time, queueNumber,
          createdAt: Date.now()
        };
        const newRef = push(ref(db, "appointments"));
        await set(newRef, appt);

        showOK(`✅ Booked for ${date} at ${toHuman(time)}. Your Queue Number is ${queueNumber}.`);
        form.reset();
        // refresh available slots after booking (listener will auto-update)
      } catch (e) {
        console.error(e);
        showErr("Something went wrong while booking. Please try again.");
        // If failure happens after slot reserved but before write, you could optionally free the slot.
      } finally {
        submitBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
